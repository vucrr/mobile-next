{"ast":null,"code":"import _JSON$stringify from \"@babel/runtime-corejs2/core-js/json/stringify\";\nimport _Date$now from \"@babel/runtime-corejs2/core-js/date/now\";\nimport _objectSpread from \"@babel/runtime-corejs2/helpers/esm/objectSpread\";\nimport _Object$keys from \"@babel/runtime-corejs2/core-js/object/keys\";\nimport _classCallCheck from \"@babel/runtime-corejs2/helpers/esm/classCallCheck\";\nimport _createClass from \"@babel/runtime-corejs2/helpers/esm/createClass\";\nimport _defineProperty from \"@babel/runtime-corejs2/helpers/esm/defineProperty\";\nimport isEmpty from 'lodash.isempty'; // import omit from 'lodash.omit'\n\nimport querystring from 'querystring';\nimport axiosInstance from \"./axiosServer\";\nimport appConfig from \"./config\";\nimport { RSAType, rasPrivateKeySign } from \"./crypto\";\nimport { ErrorLog, dictSort, getPlatform } from \"./tools\";\n\nvar Resource =\n/*#__PURE__*/\nfunction () {\n  function Resource(specs) {\n    var _this = this;\n\n    _classCallCheck(this, Resource);\n\n    _Object$keys(specs).forEach(function (key) {\n      var spec = specs[key];\n      _this[key] = _this.actionBuilder(spec);\n    });\n  }\n\n  _createClass(Resource, [{\n    key: \"actionBuilder\",\n    value: function actionBuilder(_ref) {\n      var template = _ref.template,\n          method = _ref.method,\n          _ref$baseUrl = _ref.baseUrl,\n          baseUrl = _ref$baseUrl === void 0 ? appConfig.host2 : _ref$baseUrl;\n      var buildUrl = this.getUrlBuilder(template);\n      return function (params) {\n        var url = buildUrl(params.query);\n        var config = Resource.setRequestConfig(_objectSpread({}, params, {\n          url: url,\n          method: method,\n          baseUrl: baseUrl\n        }));\n        return axiosInstance.request(config);\n      };\n    }\n  }, {\n    key: \"getUrlBuilder\",\n    value: function getUrlBuilder(template) {\n      return function (query) {\n        if (!query) return template;\n\n        _Object$keys(query).map(function (item) {\n          if (template.includes(':' + item)) {\n            template = template.replace(':' + item, query[item]);\n          }\n        });\n\n        return template;\n      };\n    }\n  }], [{\n    key: \"setRequestConfig\",\n    value: function setRequestConfig(c) {\n      var config = {\n        method: c.method,\n        url: c.url,\n        baseURL: c.baseUrl || appConfig.host2\n      };\n\n      if (c.query && !isEmpty(c.query)) {\n        // config.params = omit(c.query, 'timestamp')\n        config.params = c.query;\n      }\n\n      if (c.body && !isEmpty(c.body)) {\n        config.data = c.body;\n      }\n\n      if (c.headers && !isEmpty(c.headers)) {\n        if (c.baseUrl === appConfig.host) {\n          config.headers = {\n            'user-agent': c.headers['user-agent'],\n            cookie: c.headers.cookie || ''\n          };\n        } else if ([appConfig.host2, appConfig.host3].includes(c.baseUrl)) {\n          // Doc in http://code.aihuishou.com/airent/doc/issues/320\n          // All header names are lower cased in axios\n          var timestamp = Math.floor(_Date$now() / 1000);\n          config.headers = {\n            timestamp: timestamp,\n            sign: rasPrivateKeySign({\n              origin: decodeURIComponent(querystring.stringify(dictSort(_objectSpread({}, c.body, c.query, {\n                timestamp: timestamp\n              })))),\n              type: RSAType.SHA256,\n              privateKeyPath: appConfig.rsaKeyForBFA.private\n            }),\n            userToken: c.headers.usertoken || '',\n            userIdV2: c.headers.useridv2 || '',\n            channelId: c.headers.channelid || '',\n            platform: c.headers.platform || '',\n            utmSource: c.headers.utmsource || '',\n            utmMedium: c.headers.utmmedium || '',\n            utmCampaign: c.headers.utmcampaign || ''\n          };\n\n          if (!c.headers.platform) {\n            ErrorLog(\"\\u8B66\\u544A: api \".concat(c.baseUrl).concat(c.url, \" \\u5728\\u670D\\u52A1\\u7AEF\\u8BF7\\u6C42\\u65F6\\u7F3A\\u5C11req\\u53C2\\u6570, \\u8BF7\\u5728getInitialProps\\u4E2D\\u6DFB\\u52A0\\uFF01: \").concat(_JSON$stringify(c.headers)));\n          } // console.log('[config.headers]', config.params, config.headers)\n\n        } else {\n          config.headers = c.headers;\n        }\n      }\n\n      return config;\n    }\n  }, {\n    key: \"buildHeaders\",\n    value: function buildHeaders(req) {\n      var lowercase = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : false;\n      var headers = {\n        userToken: decodeURIComponent(req.cookies.userToken || ''),\n        userIdV2: decodeURIComponent(req.cookies.user_id_v2 || ''),\n        channelId: req.cookies.channelId || '0',\n        platform: getPlatform(req.useragent.source),\n        utmSource: req.query.utm_source || req.cookies.utm_source || '',\n        utmMedium: req.query.utm_medium || req.cookies.utm_medium || '',\n        utmCampaign: req.query.utm_campaign || req.cookies.utm_campaign || ''\n      };\n\n      if (lowercase) {\n        var result = {};\n\n        _Object$keys(headers).forEach(function (key) {\n          return result[key.toLocaleLowerCase()] = headers[key];\n        });\n\n        return result;\n      } else {\n        return headers;\n      }\n    }\n  }]);\n\n  return Resource;\n}();\n\n_defineProperty(Resource, \"GET\", 'get');\n\n_defineProperty(Resource, \"POST\", 'post');\n\n_defineProperty(Resource, \"PUT\", 'put');\n\n_defineProperty(Resource, \"DELETE\", 'delete');\n\nexport { Resource as default };","map":{"version":3,"sources":["/Users/viser/mobile-next/server/utils/resource.ts"],"names":["isEmpty","querystring","axiosInstance","appConfig","RSAType","rasPrivateKeySign","ErrorLog","dictSort","getPlatform","Resource","specs","forEach","key","spec","actionBuilder","template","method","baseUrl","host2","buildUrl","getUrlBuilder","params","url","query","config","setRequestConfig","request","map","item","includes","replace","c","baseURL","body","data","headers","host","cookie","host3","timestamp","Math","floor","sign","origin","decodeURIComponent","stringify","type","SHA256","privateKeyPath","rsaKeyForBFA","private","userToken","usertoken","userIdV2","useridv2","channelId","channelid","platform","utmSource","utmsource","utmMedium","utmmedium","utmCampaign","utmcampaign","req","lowercase","cookies","user_id_v2","useragent","source","utm_source","utm_medium","utm_campaign","result","toLocaleLowerCase"],"mappings":"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","sourcesContent":["import { AxiosRequestConfig } from 'axios'\nimport { Request } from 'express'\nimport isEmpty from 'lodash.isempty'\n// import omit from 'lodash.omit'\nimport querystring from 'querystring'\nimport { RouterRequest } from '../interfaces/router'\nimport axiosInstance from './axiosServer'\nimport appConfig from './config'\nimport { RSAType, rasPrivateKeySign } from './crypto'\nimport { ErrorLog, dictSort, getPlatform } from './tools'\n\ninterface Spec {\n  method: string\n  template: string\n  baseUrl?: string\n}\n\ntype Specs = {\n  [index: string]: Spec\n}\n\ninterface RequestConfig extends Pick<Spec, Exclude<keyof Spec, 'template'>>, RouterRequest {\n  url: string\n  body?: any\n}\n\nexport default class Resource {\n  [index: string]: any\n\n  static GET = 'get'\n  static POST = 'post'\n  static PUT = 'put'\n  static DELETE = 'delete'\n\n  constructor(specs: Specs) {\n    Object.keys(specs).forEach(key => {\n      const spec = specs[key]\n      this[key] = this.actionBuilder(spec)\n    })\n  }\n\n  static setRequestConfig(c: RequestConfig): AxiosRequestConfig {\n    const config: AxiosRequestConfig = {\n      method: c.method,\n      url: c.url,\n      baseURL: c.baseUrl || appConfig.host2,\n    }\n    if (c.query && !isEmpty(c.query)) {\n      // config.params = omit(c.query, 'timestamp')\n      config.params = c.query\n    }\n\n    if (c.body && !isEmpty(c.body)) {\n      config.data = c.body\n    }\n\n    if (c.headers && !isEmpty(c.headers)) {\n      if (c.baseUrl === appConfig.host) {\n        config.headers = {\n          'user-agent': c.headers['user-agent'],\n          cookie: c.headers.cookie || '',\n        }\n      } else if ([appConfig.host2, appConfig.host3].includes(c.baseUrl!)) {\n        // Doc in http://code.aihuishou.com/airent/doc/issues/320\n        // All header names are lower cased in axios\n        const timestamp = Math.floor(Date.now() / 1000)\n        config.headers = {\n          timestamp,\n          sign: rasPrivateKeySign({\n            origin: decodeURIComponent(querystring.stringify(dictSort({ ...c.body, ...c.query, timestamp }))),\n            type: RSAType.SHA256,\n            privateKeyPath: appConfig.rsaKeyForBFA.private,\n          }),\n          userToken: c.headers.usertoken || '',\n          userIdV2: c.headers.useridv2 || '',\n          channelId: c.headers.channelid || '',\n          platform: c.headers.platform || '',\n          utmSource: c.headers.utmsource || '',\n          utmMedium: c.headers.utmmedium || '',\n          utmCampaign: c.headers.utmcampaign || '',\n        }\n        if (!c.headers.platform) {\n          ErrorLog(\n            `警告: api ${c.baseUrl}${c.url} 在服务端请求时缺少req参数, 请在getInitialProps中添加！: ${JSON.stringify(\n              c.headers,\n            )}`,\n          )\n        }\n        // console.log('[config.headers]', config.params, config.headers)\n      } else {\n        config.headers = c.headers\n      }\n    }\n    return config\n  }\n\n  private actionBuilder({ template, method, baseUrl = appConfig.host2 }: Spec) {\n    const buildUrl = this.getUrlBuilder(template)\n    return (params: RouterRequest) => {\n      const url = buildUrl(params.query)\n      const config = Resource.setRequestConfig({ ...params, url, method, baseUrl })\n      return axiosInstance.request(config)\n    }\n  }\n\n  private getUrlBuilder(template: string) {\n    return (query: any) => {\n      if (!query) return template\n      Object.keys(query).map(item => {\n        if (template.includes(':' + item)) {\n          template = template.replace(':' + item, query[item])\n        }\n      })\n      return template\n    }\n  }\n\n  static buildHeaders(req: Request, lowercase = false) {\n    const headers: { [key: string]: string } = {\n      userToken: decodeURIComponent(req.cookies.userToken || ''),\n      userIdV2: decodeURIComponent(req.cookies.user_id_v2 || ''),\n      channelId: req.cookies.channelId || '0',\n      platform: getPlatform(req.useragent!.source),\n      utmSource: req.query.utm_source || req.cookies.utm_source || '',\n      utmMedium: req.query.utm_medium || req.cookies.utm_medium || '',\n      utmCampaign: req.query.utm_campaign || req.cookies.utm_campaign || '',\n    }\n\n    if (lowercase) {\n      const result: { [key: string]: string } = {}\n      Object.keys(headers).forEach(key => (result[key.toLocaleLowerCase()] = headers[key]))\n      return result\n    } else {\n      return headers\n    }\n  }\n}\n"]},"metadata":{},"sourceType":"module"}
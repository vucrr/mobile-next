{"ast":null,"code":"import _Date$now from \"@babel/runtime-corejs2/core-js/date/now\";\nimport _regeneratorRuntime from \"@babel/runtime-corejs2/regenerator\";\nimport _asyncToGenerator from \"@babel/runtime-corejs2/helpers/esm/asyncToGenerator\";\nimport { getHeaders2 } from 'actions/actionHelper';\nimport { GET_NAV_ICONS, HIDDEN_TABBAR, INIT_TABBAR, RAS_PRIVATE_KEY, TOGGLE_TABBAR } from 'constant/index';\nimport Cookies from 'js-cookie';\nimport Router from 'next/router';\nimport { createAction } from 'redux-actions';\nimport { ENV } from \"../utils/config\";\nimport { axios, tools } from 'utils/index';\nexport var initTabBar = createAction(INIT_TABBAR);\nexport var toggleTabBar = createAction(TOGGLE_TABBAR);\nexport var hiddenTabBar = createAction(HIDDEN_TABBAR);\nvar receiveRasPrivateKey = createAction(RAS_PRIVATE_KEY);\nexport var fetchRasPrivateKey = function fetchRasPrivateKey() {\n  return (\n    /*#__PURE__*/\n    function () {\n      var _ref = _asyncToGenerator(\n      /*#__PURE__*/\n      _regeneratorRuntime.mark(function _callee(dispatch) {\n        var _timespan, _ref2, data;\n\n        return _regeneratorRuntime.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                _context.prev = 0;\n                _timespan = new Date().getTime().toString();\n                _context.next = 4;\n                return axios.post('node-api/signature', {\n                  origin: _timespan\n                });\n\n              case 4:\n                _ref2 = _context.sent;\n                data = _ref2.data;\n                return _context.abrupt(\"return\", data && dispatch(receiveRasPrivateKey({\n                  key: 'openAlipay',\n                  timespan: _timespan,\n                  token: data.token\n                })));\n\n              case 9:\n                _context.prev = 9;\n                _context.t0 = _context[\"catch\"](0);\n                tools.ErrorLog(_context.t0);\n\n              case 12:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee, null, [[0, 9]]);\n      }));\n\n      return function (_x) {\n        return _ref.apply(this, arguments);\n      };\n    }()\n  );\n};\nexport var redirectLogin =\n/*#__PURE__*/\nfunction () {\n  var _ref4 = _asyncToGenerator(\n  /*#__PURE__*/\n  _regeneratorRuntime.mark(function _callee2(_ref3) {\n    var isServer, res, asPath, loginUrl;\n    return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n      while (1) {\n        switch (_context2.prev = _context2.next) {\n          case 0:\n            isServer = _ref3.isServer, res = _ref3.res, asPath = _ref3.asPath;\n            // 支付宝芝麻、花呗渠道需静默登录，故跳转至php的中间件\n            loginUrl = \"/next-api/account/login?redirect=\".concat(encodeURIComponent(asPath));\n\n            if (!isServer) {\n              _context2.next = 7;\n              break;\n            }\n\n            res.redirect(loginUrl);\n            res.end();\n            _context2.next = 9;\n            break;\n\n          case 7:\n            _context2.next = 9;\n            return Router.push(loginUrl);\n\n          case 9:\n          case \"end\":\n            return _context2.stop();\n        }\n      }\n    }, _callee2);\n  }));\n\n  return function redirectLogin(_x2) {\n    return _ref4.apply(this, arguments);\n  };\n}();\n\nvar redirectBindPhone =\n/*#__PURE__*/\nfunction () {\n  var _ref6 = _asyncToGenerator(\n  /*#__PURE__*/\n  _regeneratorRuntime.mark(function _callee3(_ref5) {\n    var isServer, res, asPath, phone, url;\n    return _regeneratorRuntime.wrap(function _callee3$(_context3) {\n      while (1) {\n        switch (_context3.prev = _context3.next) {\n          case 0:\n            isServer = _ref5.isServer, res = _ref5.res, asPath = _ref5.asPath, phone = _ref5.phone;\n            url = phone ? \"/myaccount/bind/bind-phone?phone=\".concat(phone, \"&redirect=\").concat(encodeURIComponent(asPath)) : \"/myaccount/bind/change-phone?redirect=\".concat(encodeURIComponent(asPath));\n\n            if (!isServer) {\n              _context3.next = 7;\n              break;\n            }\n\n            res.redirect(url);\n            res.end();\n            _context3.next = 9;\n            break;\n\n          case 7:\n            _context3.next = 9;\n            return Router.push(url);\n\n          case 9:\n          case \"end\":\n            return _context3.stop();\n        }\n      }\n    }, _callee3);\n  }));\n\n  return function redirectBindPhone(_x3) {\n    return _ref6.apply(this, arguments);\n  };\n}();\n\nvar getAlipayBindInfo =\n/*#__PURE__*/\nfunction () {\n  var _ref7 = _asyncToGenerator(\n  /*#__PURE__*/\n  _regeneratorRuntime.mark(function _callee4(alipayUserId, req) {\n    var url, headers, params, _ref8, data;\n\n    return _regeneratorRuntime.wrap(function _callee4$(_context4) {\n      while (1) {\n        switch (_context4.prev = _context4.next) {\n          case 0:\n            url = 'node-api/account/bind_phone/alipay_user_bind_info';\n            headers = getHeaders2(req);\n            params = {\n              // 这里特殊处理，h5传的参数是 alipay_user_id\n              alipay_user_id: alipayUserId,\n              type: 2\n            };\n            _context4.prev = 3;\n            _context4.next = 6;\n            return axios.get(url, {\n              params: params,\n              headers: headers\n            });\n\n          case 6:\n            _ref8 = _context4.sent;\n            data = _ref8.data;\n            return _context4.abrupt(\"return\", data);\n\n          case 11:\n            _context4.prev = 11;\n            _context4.t0 = _context4[\"catch\"](3);\n            tools.ErrorLog(_context4.t0);\n\n          case 14:\n          case \"end\":\n            return _context4.stop();\n        }\n      }\n    }, _callee4, null, [[3, 11]]);\n  }));\n\n  return function getAlipayBindInfo(_x4, _x5) {\n    return _ref7.apply(this, arguments);\n  };\n}();\n\nexport var checkLogin = function checkLogin(_ref9) {\n  var isServer = _ref9.isServer,\n      res = _ref9.res,\n      req = _ref9.req,\n      asPath = _ref9.asPath;\n  return (\n    /*#__PURE__*/\n    function () {\n      var _ref10 = _asyncToGenerator(\n      /*#__PURE__*/\n      _regeneratorRuntime.mark(function _callee5(_, getState) {\n        var alipayUserId, isBindAlipay, data, expires;\n        return _regeneratorRuntime.wrap(function _callee5$(_context5) {\n          while (1) {\n            switch (_context5.prev = _context5.next) {\n              case 0:\n                if (getState().getIn(['serverApp', 'auth', 'isLogin'])) {\n                  _context5.next = 4;\n                  break;\n                }\n\n                _context5.next = 3;\n                return redirectLogin({\n                  isServer: isServer,\n                  res: res,\n                  asPath: asPath\n                });\n\n              case 3:\n                return _context5.abrupt(\"return\", false);\n\n              case 4:\n                if (!(getState().getIn(['serverApp', 'utm', 'channelId']) === 41 || !getState().getIn(['serverApp', 'ua', 'isAlipay']) || ENV === 'dev')) {\n                  _context5.next = 6;\n                  break;\n                }\n\n                return _context5.abrupt(\"return\", true);\n\n              case 6:\n                if (!(isServer && !req)) {\n                  _context5.next = 8;\n                  break;\n                }\n\n                return _context5.abrupt(\"return\", true);\n\n              case 8:\n                alipayUserId = (isServer ? req.cookies.alipay_user_id : Cookies.get('alipay_user_id')) || '';\n\n                if (alipayUserId) {\n                  _context5.next = 13;\n                  break;\n                }\n\n                _context5.next = 12;\n                return redirectLogin({\n                  isServer: isServer,\n                  res: res,\n                  asPath: asPath\n                });\n\n              case 12:\n                return _context5.abrupt(\"return\", false);\n\n              case 13:\n                isBindAlipay = isServer ? req.cookies['is_alipay_bind'] === '1' : Cookies.get('is_alipay_bind') === '1';\n\n                if (!isBindAlipay) {\n                  _context5.next = 16;\n                  break;\n                }\n\n                return _context5.abrupt(\"return\", true);\n\n              case 16:\n                _context5.next = 18;\n                return getAlipayBindInfo(alipayUserId, req);\n\n              case 18:\n                data = _context5.sent;\n\n                if (!(data && data.res)) {\n                  _context5.next = 22;\n                  break;\n                }\n\n                // 已经绑定\n                if (isServer) {\n                  expires = new Date(_Date$now() + 24 * 60 * 60 * 1000);\n                  res.cookie('is_alipay_bind', '1', {\n                    expires: expires\n                  });\n                } else {\n                  Cookies.set('is_alipay_bind', '1', {\n                    expires: 1\n                  });\n                }\n\n                return _context5.abrupt(\"return\", true);\n\n              case 22:\n                _context5.next = 24;\n                return redirectBindPhone({\n                  isServer: isServer,\n                  res: res,\n                  asPath: asPath,\n                  phone: data && data.phone\n                });\n\n              case 24:\n                return _context5.abrupt(\"return\", false);\n\n              case 25:\n              case \"end\":\n                return _context5.stop();\n            }\n          }\n        }, _callee5);\n      }));\n\n      return function (_x6, _x7) {\n        return _ref10.apply(this, arguments);\n      };\n    }()\n  );\n};\nexport var redirectTo =\n/*#__PURE__*/\nfunction () {\n  var _ref12 = _asyncToGenerator(\n  /*#__PURE__*/\n  _regeneratorRuntime.mark(function _callee6(_ref11) {\n    var isServer, res, path;\n    return _regeneratorRuntime.wrap(function _callee6$(_context6) {\n      while (1) {\n        switch (_context6.prev = _context6.next) {\n          case 0:\n            isServer = _ref11.isServer, res = _ref11.res, path = _ref11.path;\n\n            if (!isServer) {\n              _context6.next = 6;\n              break;\n            }\n\n            res.redirect(path);\n            res.end();\n            _context6.next = 8;\n            break;\n\n          case 6:\n            _context6.next = 8;\n            return Router.push(path);\n\n          case 8:\n          case \"end\":\n            return _context6.stop();\n        }\n      }\n    }, _callee6);\n  }));\n\n  return function redirectTo(_x8) {\n    return _ref12.apply(this, arguments);\n  };\n}();\nvar receiveNavIcons = createAction(GET_NAV_ICONS);\nexport var fetchNavIcons = function fetchNavIcons() {\n  return (\n    /*#__PURE__*/\n    function () {\n      var _ref13 = _asyncToGenerator(\n      /*#__PURE__*/\n      _regeneratorRuntime.mark(function _callee7(dispatch) {\n        var url, headers, _ref14, data;\n\n        return _regeneratorRuntime.wrap(function _callee7$(_context7) {\n          while (1) {\n            switch (_context7.prev = _context7.next) {\n              case 0:\n                _context7.prev = 0;\n                url = 'node-api/v2c/common/getNavIcons';\n                headers = getHeaders2();\n                _context7.next = 5;\n                return axios.get(url, {\n                  headers: headers\n                });\n\n              case 5:\n                _ref14 = _context7.sent;\n                data = _ref14.data;\n                return _context7.abrupt(\"return\", data && dispatch(receiveNavIcons(data)));\n\n              case 10:\n                _context7.prev = 10;\n                _context7.t0 = _context7[\"catch\"](0);\n                tools.ErrorLog(_context7.t0);\n\n              case 13:\n              case \"end\":\n                return _context7.stop();\n            }\n          }\n        }, _callee7, null, [[0, 10]]);\n      }));\n\n      return function (_x9) {\n        return _ref13.apply(this, arguments);\n      };\n    }()\n  );\n};","map":{"version":3,"sources":["/Users/viser/mobile-next/src/actions/app.ts"],"names":["getHeaders2","GET_NAV_ICONS","HIDDEN_TABBAR","INIT_TABBAR","RAS_PRIVATE_KEY","TOGGLE_TABBAR","Cookies","Router","createAction","ENV","axios","tools","initTabBar","toggleTabBar","hiddenTabBar","receiveRasPrivateKey","fetchRasPrivateKey","dispatch","timespan","Date","getTime","toString","post","origin","data","key","token","ErrorLog","redirectLogin","isServer","res","asPath","loginUrl","encodeURIComponent","redirect","end","push","redirectBindPhone","phone","url","getAlipayBindInfo","alipayUserId","req","headers","params","alipay_user_id","type","get","checkLogin","_","getState","getIn","cookies","isBindAlipay","expires","cookie","set","redirectTo","path","receiveNavIcons","fetchNavIcons"],"mappings":"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","sourcesContent":["import { getHeaders2 } from 'actions/actionHelper'\nimport { GET_NAV_ICONS, HIDDEN_TABBAR, INIT_TABBAR, RAS_PRIVATE_KEY, TOGGLE_TABBAR } from 'constant/index'\nimport { NavIconsReturns } from 'interfaces/common/navIcons'\nimport Cookies from 'js-cookie'\nimport Router from 'next/router'\nimport { Action, Dispatch } from 'redux'\nimport { createAction } from 'redux-actions'\nimport { ENV } from 'utils/config'\nimport { axios, tools } from 'utils/index'\n\nexport interface InitTabBarPayload {\n  show: boolean\n  selectedTab: string\n}\n\ninterface RasPrivateKeyPayload {\n  key: string\n  timespan: string\n  token: string\n}\n\nexport const initTabBar = createAction<InitTabBarPayload>(INIT_TABBAR)\n\nexport const toggleTabBar = createAction(TOGGLE_TABBAR)\n\nexport const hiddenTabBar = createAction(HIDDEN_TABBAR)\n\nconst receiveRasPrivateKey = createAction<RasPrivateKeyPayload>(RAS_PRIVATE_KEY)\n\nexport const fetchRasPrivateKey = () => async (dispatch: Dispatch<Action>) => {\n  try {\n    const timespan = new Date().getTime().toString()\n    const { data } = await axios.post<any>('node-api/signature', { origin: timespan })\n    return data && dispatch(receiveRasPrivateKey({ key: 'openAlipay', timespan, token: data.token }))\n  } catch (err) {\n    tools.ErrorLog(err)\n  }\n}\n\nexport const redirectLogin = async ({ isServer, res, asPath }: any) => {\n  // 支付宝芝麻、花呗渠道需静默登录，故跳转至php的中间件\n  const loginUrl = `/next-api/account/login?redirect=${encodeURIComponent(asPath)}`\n  if (isServer) {\n    res.redirect(loginUrl)\n    res.end()\n  } else {\n    await Router.push(loginUrl)\n  }\n}\n\nconst redirectBindPhone = async ({ isServer, res, asPath, phone }: any) => {\n  const url = phone\n    ? `/myaccount/bind/bind-phone?phone=${phone}&redirect=${encodeURIComponent(asPath)}`\n    : `/myaccount/bind/change-phone?redirect=${encodeURIComponent(asPath)}`\n  if (isServer) {\n    res.redirect(url)\n    res.end()\n  } else {\n    await Router.push(url)\n  }\n}\n\nconst getAlipayBindInfo = async (alipayUserId: string, req: any) => {\n  const url = 'node-api/account/bind_phone/alipay_user_bind_info'\n  const headers = getHeaders2(req)\n  const params = {\n    // 这里特殊处理，h5传的参数是 alipay_user_id\n    alipay_user_id: alipayUserId,\n    type: 2,\n  }\n  try {\n    const { data } = await axios.get(url, { params, headers })\n    return data\n  } catch (err) {\n    tools.ErrorLog(err)\n  }\n}\n\nexport const checkLogin = ({ isServer, res, req, asPath }: any) => async (_: Dispatch<Action>, getState: Function) => {\n  if (!getState().getIn(['serverApp', 'auth', 'isLogin'])) {\n    // 支付宝芝麻、花呗渠道需静默登录，故跳转至php的中间件\n    await redirectLogin({ isServer, res, asPath })\n    return false\n  }\n  // 轻松用 || 非支付宝渠道 不需要验证账号合并问题。直接返回true\n  if (\n    getState().getIn(['serverApp', 'utm', 'channelId']) === 41 ||\n    !getState().getIn(['serverApp', 'ua', 'isAlipay']) ||\n    ENV === 'dev'\n  ) {\n    return true\n  }\n  // 支付宝渠道验证手机号\n  if (isServer && !req) {\n    // 兼容没有传 req 的请求 后期可删\n    return true\n  }\n  const alipayUserId = (isServer ? req.cookies.alipay_user_id : Cookies.get('alipay_user_id')) || ''\n  if (!alipayUserId) {\n    await redirectLogin({ isServer, res, asPath })\n    return false\n  }\n  const isBindAlipay = isServer ? req.cookies['is_alipay_bind'] === '1' : Cookies.get('is_alipay_bind') === '1'\n  if (isBindAlipay) {\n    return true\n  }\n  const data = await getAlipayBindInfo(alipayUserId, req)\n  if (data && data.res) {\n    // 已经绑定\n    if (isServer) {\n      const expires = new Date(Date.now() + 24 * 60 * 60 * 1000)\n      res.cookie('is_alipay_bind', '1', { expires })\n    } else {\n      Cookies.set('is_alipay_bind', '1', { expires: 1 })\n    }\n    return true\n  }\n  // 未绑定\n  await redirectBindPhone({ isServer, res, asPath, phone: data && data.phone })\n  return false\n}\n\nexport const redirectTo = async ({ isServer, res, path }: any) => {\n  if (isServer) {\n    res.redirect(path)\n    res.end()\n  } else {\n    await Router.push(path)\n  }\n}\n\nconst receiveNavIcons = createAction<NavIconsReturns>(GET_NAV_ICONS)\n\nexport const fetchNavIcons = () => async (dispatch: Dispatch<Action>) => {\n  try {\n    const url = 'node-api/v2c/common/getNavIcons'\n    const headers = getHeaders2()\n    const { data } = await axios.get<NavIconsReturns>(url, { headers })\n    return data && dispatch(receiveNavIcons(data))\n  } catch (err) {\n    tools.ErrorLog(err)\n  }\n}\n"]},"metadata":{},"sourceType":"module"}
{"ast":null,"code":"import _Promise from \"@babel/runtime-corejs2/core-js/promise\";\nimport _parseInt from \"@babel/runtime-corejs2/core-js/parse-int\";\nimport _Object$keys from \"@babel/runtime-corejs2/core-js/object/keys\";\nimport _getIterator from \"@babel/runtime-corejs2/core-js/get-iterator\";\nimport axios from 'axios';\nimport { DES3ECBDecrypt } from \"../../server/utils/crypto\";\nimport { isProd } from \"./config\";\nexport function renderProduct(oldProduct) {\n  return {\n    id: oldProduct.id || '',\n    title: oldProduct.title || '',\n    price: oldProduct.price || '',\n    // tag: oldProduct.tag || '',\n    // assurance: oldProduct.assurance || '',\n    imgUrl: oldProduct.image || '',\n    noBadge: true,\n    baseFee: oldProduct.baseFee || ''\n  };\n}\nexport function renderCenterProduct(oldProduct) {\n  return {\n    id: oldProduct.id_activity || '',\n    title: oldProduct.title || '',\n    price: oldProduct.perMonthPrice || '',\n    imgUrl: oldProduct.activity_img || '',\n    noBadge: true\n  };\n} // order/return steps\n\nexport function renderSteps(old, index) {\n  var tips = [old.tips.substring(0, old.tips.indexOf('\\n')), old.tips.substring(old.tips.indexOf('\\n') + 1)];\n  return {\n    remark: old.title,\n    content: old.tips.indexOf('\\n') === -1 ? [old.tips] : tips,\n    status: index === 0 ? 1 : 5\n  };\n}\nexport function ErrorLog(message) {\n  var isClient = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : false;\n  console.error(message);\n  isProd && !isClient && axios({\n    method: 'post',\n    url: 'https://oapi.dingtalk.com/robot/send?access_token=ed88e1fa1793798f95cf7df824ca66a548399a9c772d2375fdd6f163fec78fd4',\n    data: {\n      msgtype: 'text',\n      text: {\n        content: message\n      },\n      at: {\n        atMobiles: ['13023105710'],\n        isAtAll: false\n      }\n    }\n  });\n}\nexport function dictSort(obj) {\n  var dict = {};\n  var _iteratorNormalCompletion = true;\n  var _didIteratorError = false;\n  var _iteratorError = undefined;\n\n  try {\n    for (var _iterator = _getIterator(_Object$keys(obj).sort()), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {\n      var key = _step.value;\n      dict[key] = obj[key];\n    }\n  } catch (err) {\n    _didIteratorError = true;\n    _iteratorError = err;\n  } finally {\n    try {\n      if (!_iteratorNormalCompletion && _iterator.return != null) {\n        _iterator.return();\n      }\n    } finally {\n      if (_didIteratorError) {\n        throw _iteratorError;\n      }\n    }\n  }\n\n  return dict;\n}\nexport function noop() {} // tslint:disable-line:no-empty\n\nexport function checkLogin(req) {\n  var userId = req.cookies && req.cookies.user_id_v2 || req.headers && req.headers.useridv2;\n  if (!userId || !isBase64(userId)) return false;\n\n  try {\n    var text = DES3ECBDecrypt({\n      key: '',\n      toDecrypt: userId\n    });\n\n    var num = _parseInt(text, 10);\n\n    return num > 0;\n  } catch (err) {\n    return false;\n  }\n}\nexport function isBase64(text) {\n  return Buffer.from(text, 'base64').toString('base64') === text;\n}\nexport function errorHandler(res) {\n  return {\n    status: res && res.status || 500,\n    code: res && res.code || 500,\n    errorMsg: res && (res.msg || res.reason) || '网络请求错误'\n  };\n}\nexport function authHandler() {\n  return {\n    status: 401,\n    errorMsg: '登录认证失败'\n  };\n}\nexport function BFA_Returns(res) {\n  if (!res) throw new Error('node api no res');\n  if ([1, 200].includes(res.code) || res.status === 101) return res.data;\n  return errorHandler(res);\n}\nexport function getDomain(hostname) {\n  if (hostname === 'm.xianghuanji.com') {\n    return '.xianghuanji.com';\n  }\n\n  return hostname;\n}\nexport function getPlatform(userAgent) {\n  if (/AlipayClient/.test(userAgent)) {\n    return 'alipay';\n  } else if (/MicroMessenger/.test(userAgent)) {\n    return 'wechat';\n  } else if (/enjoyChanging/.test(userAgent) && /platform\\/iOS/.test(userAgent)) {\n    return 'xhj_ios_app';\n  } else if (/Android;enjoyChanging_native/.test(userAgent)) {\n    return 'xhj_android_app';\n  }\n\n  return 'h5_browser';\n}\nexport function getUA(ua, channelId) {\n  return {\n    isAlipay: /AlipayClient/.test(ua),\n    isWechat: /MicroMessenger/.test(ua),\n    isApp: /enjoyChanging/.test(ua) || channelId === 19 || channelId === 22,\n    isAndroidApp: /Android;enjoyChanging_native/.test(ua) || channelId === 22,\n    isIOSApp: channelId === 19,\n    // /enjoyChanging/.test(ua) && /platform\\/iOS/.test(ua),\n    isAhsApp: /aihuishou_official_/.test(ua),\n    isNuomiApp: /Nuomi/.test(ua),\n    isIOS: !!ua.match(/\\(i[^;]+;( U;)? CPU.+Mac OS X/),\n    android: ua.indexOf('Android') > -1 || ua.indexOf('Linux') > -1\n  };\n}\nexport var delayHandle = function delayHandle(tick) {\n  return new _Promise(function (resolve) {\n    if (tick > 0) {\n      setTimeout(function () {\n        return resolve();\n      }, tick * 1000);\n    } else {\n      resolve();\n    }\n  });\n};","map":{"version":3,"sources":["/Users/viser/mobile-next/server/utils/tools.ts"],"names":["axios","DES3ECBDecrypt","isProd","renderProduct","oldProduct","id","title","price","imgUrl","image","noBadge","baseFee","renderCenterProduct","id_activity","perMonthPrice","activity_img","renderSteps","old","index","tips","substring","indexOf","remark","content","status","ErrorLog","message","isClient","console","error","method","url","data","msgtype","text","at","atMobiles","isAtAll","dictSort","obj","dict","sort","key","noop","checkLogin","req","userId","cookies","user_id_v2","headers","useridv2","isBase64","toDecrypt","num","err","Buffer","from","toString","errorHandler","res","code","errorMsg","msg","reason","authHandler","BFA_Returns","Error","includes","getDomain","hostname","getPlatform","userAgent","test","getUA","ua","channelId","isAlipay","isWechat","isApp","isAndroidApp","isIOSApp","isAhsApp","isNuomiApp","isIOS","match","android","delayHandle","tick","resolve","setTimeout"],"mappings":"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","sourcesContent":["import axios from 'axios'\nimport { HTTPInfra } from 'interfaces/model'\nimport { DES3ECBDecrypt } from '../../server/utils/crypto'\nimport { ErrorReturn } from '../interfaces/error'\nimport { RouterRequest } from '../interfaces/router'\nimport { isProd } from './config'\n\ninterface Product {\n  id: number\n  title: string\n  price: string\n  // tag: string\n  assurance: string\n  image: string\n  baseFee: string\n}\n\nexport function renderProduct(oldProduct: Product) {\n  return {\n    id: oldProduct.id || '',\n    title: oldProduct.title || '',\n    price: oldProduct.price || '',\n    // tag: oldProduct.tag || '',\n    // assurance: oldProduct.assurance || '',\n    imgUrl: oldProduct.image || '',\n    noBadge: true,\n    baseFee: oldProduct.baseFee || '',\n  }\n}\n\nexport function renderCenterProduct(oldProduct: any) {\n  return {\n    id: oldProduct.id_activity || '',\n    title: oldProduct.title || '',\n    price: oldProduct.perMonthPrice || '',\n    imgUrl: oldProduct.activity_img || '',\n    noBadge: true,\n  }\n}\n\n// order/return steps\nexport function renderSteps(old: any, index: number) {\n  const tips = [old.tips.substring(0, old.tips.indexOf('\\n')), old.tips.substring(old.tips.indexOf('\\n') + 1)]\n  return {\n    remark: old.title,\n    content: old.tips.indexOf('\\n') === -1 ? [old.tips] : tips,\n    status: index === 0 ? 1 : 5,\n  }\n}\n\nexport function ErrorLog(message: Error | string, isClient = false) {\n  console.error(message)\n  isProd &&\n    !isClient &&\n    axios({\n      method: 'post',\n      url:\n        'https://oapi.dingtalk.com/robot/send?access_token=ed88e1fa1793798f95cf7df824ca66a548399a9c772d2375fdd6f163fec78fd4',\n      data: {\n        msgtype: 'text',\n        text: {\n          content: message,\n        },\n        at: {\n          atMobiles: ['13023105710'],\n          isAtAll: false,\n        },\n      },\n    })\n}\n\nexport function dictSort(obj: any): object {\n  const dict = {} as any\n  for (const key of Object.keys(obj).sort()) {\n    dict[key] = obj[key]\n  }\n  return dict\n}\n\nexport function noop() {} // tslint:disable-line:no-empty\n\nexport function checkLogin(req: RouterRequest) {\n  const userId = (req.cookies && req.cookies.user_id_v2) || (req.headers && (req.headers.useridv2 as string))\n  if (!userId || !isBase64(userId)) return false\n  try {\n    const text = DES3ECBDecrypt({ key: '', toDecrypt: userId })\n    const num = parseInt(text, 10)\n    return num > 0\n  } catch (err) {\n    return false\n  }\n}\n\nexport function isBase64(text: string): boolean {\n  return Buffer.from(text, 'base64').toString('base64') === text\n}\n\ninterface ErrRes {\n  status: number\n  code?: number\n  msg?: string\n  reason?: string\n}\n\nexport function errorHandler(res: ErrRes): ErrorReturn {\n  return {\n    status: (res && res.status) || 500,\n    code: (res && res.code) || 500,\n    errorMsg: (res && (res.msg || res.reason)) || '网络请求错误',\n  }\n}\n\nexport function authHandler(): ErrorReturn {\n  return {\n    status: 401,\n    errorMsg: '登录认证失败',\n  }\n}\n\nexport function BFA_Returns(res: HTTPInfra<any>) {\n  if (!res) throw new Error('node api no res')\n  if ([1, 200].includes(res.code as number) || res.status === 101) return res.data\n  return errorHandler(res)\n}\n\nexport function getDomain(hostname: string): string {\n  if (hostname === 'm.xianghuanji.com') {\n    return '.xianghuanji.com'\n  }\n  return hostname\n}\n\nexport function getPlatform(userAgent: string) {\n  if (/AlipayClient/.test(userAgent)) {\n    return 'alipay'\n  } else if (/MicroMessenger/.test(userAgent)) {\n    return 'wechat'\n  } else if (/enjoyChanging/.test(userAgent) && /platform\\/iOS/.test(userAgent)) {\n    return 'xhj_ios_app'\n  } else if (/Android;enjoyChanging_native/.test(userAgent)) {\n    return 'xhj_android_app'\n  }\n  return 'h5_browser'\n}\n\nexport function getUA(ua: any, channelId: number) {\n  return {\n    isAlipay: /AlipayClient/.test(ua),\n    isWechat: /MicroMessenger/.test(ua),\n    isApp: /enjoyChanging/.test(ua) || channelId === 19 || channelId === 22,\n    isAndroidApp: /Android;enjoyChanging_native/.test(ua) || channelId === 22,\n    isIOSApp: channelId === 19, // /enjoyChanging/.test(ua) && /platform\\/iOS/.test(ua),\n    isAhsApp: /aihuishou_official_/.test(ua),\n    isNuomiApp: /Nuomi/.test(ua),\n    isIOS: !!ua.match(/\\(i[^;]+;( U;)? CPU.+Mac OS X/),\n    android: ua.indexOf('Android') > -1 || ua.indexOf('Linux') > -1,\n  }\n}\n\nexport const delayHandle = (tick: number) => {\n  return new Promise<void>(resolve => {\n    if (tick > 0) {\n      setTimeout(() => resolve(), tick * 1000)\n    } else {\n      resolve()\n    }\n  })\n}\n"]},"metadata":{},"sourceType":"module"}